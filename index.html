<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>ROW Marketing - Task Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* your same CSS untouched */
</style>
</head>
<body>

<header>
  <h1>ROW Marketing - Task Portal</h1>
  <nav>
    <button onclick="openModal('clientModal')">Clients</button>
    <button onclick="openModal('teamModal')">Team</button>
    <button onclick="openModal('attendanceModal'); onOpenAttendance();">Attendance</button>
  </nav>
</header>

<main>
  <!-- your same UI here -->
</main>

<!-- your same modals here -->

<!-- ================= Firebase + App Script ================= -->
<script type="module">
  // Import Firebase SDK
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getDatabase, ref, set, get, child } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

  // 🔑 Your Firebase config (from console)
  const firebaseConfig = {
    apiKey: "AIzaSyB_XW2aQbvfLrD-UFNflcoC73YJRTpfl3k",
    authDomain: "row-task.firebaseapp.com",
    databaseURL: "https://row-task-default-rtdb.firebaseio.com",   // IMPORTANT: Add this line
    projectId: "row-task",
    storageBucket: "row-task.appspot.com",
    messagingSenderId: "17432691787",
    appId: "1:17432691787:web:b3b474db8e4fd43b83f9ce"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  // ---------------- Your App Data ----------------
  let tasks = [], clients = [], team = [], attendance = [];

  // ✅ Load data from Firebase
  async function loadData() {
    try {
      const snapshot = await get(child(ref(db), "data"));
      if (snapshot.exists()) {
        let d = snapshot.val();
        tasks = d.tasks || [];
        clients = d.clients || ["Client A"];
        team = d.team || ["Rohama","Fakhar","Mubashir"];
        attendance = d.attendance || [];
      } else {
        clients = ["Client A"];
        team = ["Rohama","Fakhar","Mubashir"];
        attendance = [];
      }
    } catch (e) {
      console.error("Error loading:", e);
      clients=["Client A"]; team=["Rohama","Fakhar","Mubashir"]; attendance=[];
    }
    loadDropdowns(); renderTable(); updateSummary(); renderTodayAttendance();
  }

  // ✅ Save data to Firebase
  async function saveData() {
    try {
      await set(ref(db, "data"), { tasks, clients, team, attendance });
    } catch (e) {
      console.error("Error saving:", e);
    }
    updateSummary(); renderTodayAttendance();
  }

  // ---------------- Your Existing Functions (unchanged) ----------------
  function addOrUpdateTask(){let c=document.getElementById("clientName").value;let t=document.getElementById("taskName").value.trim();let a=document.getElementById("assignedTo").value;let s=document.getElementById("statusSelect").value;let d=document.getElementById("dueDate").value;let r=document.getElementById("repeatSelect").value;let idx=document.getElementById("editIndex").value;if(!c||!t||!a){alert("Fill all fields");return;}if(idx){tasks[idx]={client:c,task:t,assigned:a,status:s,due:d,repeat:r};}else{tasks.push({client:c,task:t,assigned:a,status:s,due:d,repeat:r});}document.getElementById("editIndex").value="";saveData();renderTable();}
  function editTask(i){let t=tasks[i];document.getElementById("clientName").value=t.client;document.getElementById("taskName").value=t.task;document.getElementById("assignedTo").value=t.assigned;document.getElementById("statusSelect").value=t.status;document.getElementById("dueDate").value=t.due||todayStr();document.getElementById("repeatSelect").value=t.repeat||"";document.getElementById("editIndex").value=i;}
  function deleteTask(i){if(confirm("Delete?")){tasks.splice(i,1);saveData();renderTable();}}
  function changeStatus(i){let s=tasks[i].status;tasks[i].status=s==="pending"?"inprogress":s==="inprogress"?"completed":"pending";saveData();renderTable();}
  function renderTable(){let tb=document.querySelector("#taskTable tbody");tb.innerHTML="";tasks.forEach((t,i)=>{tb.innerHTML+=`<tr><td>${t.client}</td><td>${t.task}</td><td>${t.assigned}</td><td><button class="status-btn ${t.status}" onclick="changeStatus(${i})">${statusText(t.status)}</button></td><td>${t.due||"-"}</td><td>${t.repeat||"-"}</td><td><button onclick="editTask(${i})">✏</button> <button onclick="deleteTask(${i})">🗑</button></td></tr>`;});}
  function updateSummary(){let p=tasks.filter(t=>t.status==="pending").length;let ip=tasks.filter(t=>t.status==="inprogress").length;let c=tasks.filter(t=>t.status==="completed").length;document.getElementById("pendingCount").textContent=p;document.getElementById("inProgressCount").textContent=ip;document.getElementById("completedCount").textContent=c;updateCharts(p,ip,c);}
  let statusChart,teamChart;
  function updateCharts(p,ip,c){
    if(statusChart)statusChart.destroy();
    statusChart=new Chart(document.getElementById("statusChart"),{type:"doughnut",data:{labels:["Pending","In Progress","Completed"],datasets:[{data:[p,ip,c],backgroundColor:["#dc3545","#ffc107","#28a745"]}]},options:{plugins:{legend:{display:false}}}});
    if(teamChart)teamChart.destroy();
    let members=team;
    let pendingCounts   = members.map(m=>tasks.filter(t=>t.assigned===m && t.status==="pending").length);
    let inProgressCounts= members.map(m=>tasks.filter(t=>t.assigned===m && t.status==="inprogress").length);
    let completedCounts = members.map(m=>tasks.filter(t=>t.assigned===m && t.status==="completed").length);
    teamChart=new Chart(document.getElementById("teamChart"),{type:"bar",data:{labels:members,datasets:[{label:"Pending",data:pendingCounts,backgroundColor:"#dc3545"},{label:"In Progress",data:inProgressCounts,backgroundColor:"#ffc107"},{label:"Completed",data:completedCounts,backgroundColor:"#28a745"}]},options:{responsive:true,plugins:{legend:{position:"bottom"}},scales:{x:{stacked:true},y:{stacked:true,beginAtZero:true}}}});
  }
  function renderClients(){let tb=document.getElementById("clientTable");tb.innerHTML="";clients.forEach((c,i)=>tb.innerHTML+=`<tr><td>${c}</td><td><button onclick="deleteClient(${i})">🗑</button></td></tr>`);}
  function addClient(){let n=document.getElementById("newClient").value.trim();if(n&&!clients.includes(n)){clients.push(n);document.getElementById("newClient").value="";saveData();renderClients();loadDropdowns();}}
  function deleteClient(i){if(tasks.some(t=>t.client===clients[i])){alert("Client in use");return;}clients.splice(i,1);saveData();renderClients();loadDropdowns();}
  function renderTeam(){let tb=document.getElementById("teamTable");tb.innerHTML="";team.forEach((m,i)=>tb.innerHTML+=`<tr><td>${m}</td><td><button onclick="deleteTeam(${i})">🗑</button></td></tr>`);}
  function addTeam(){let n=document.getElementById("newTeam").value.trim();if(n&&!team.includes(n)){team.push(n);document.getElementById("newTeam").value="";saveData();renderTeam();loadDropdowns();}}
  function deleteTeam(i){if(tasks.some(t=>t.assigned===team[i])){alert("Member in use");return;}team.splice(i,1);saveData();renderTeam();loadDropdowns();}
  function onOpenAttendance(){document.getElementById("attendanceDate").value=todayStr();loadAttendanceMembers();}
  function loadAttendanceMembers(){let sel=document.getElementById("attendanceMember");sel.innerHTML=team.map(m=>`<option>${m}</option>`).join("");}
  function saveSingleAttendance(){let d=document.getElementById("attendanceDate").value;let m=document.getElementById("attendanceMember").value;let s=document.getElementById("attendanceStatus").value;let rec=attendance.find(a=>a.date===d&&a.member===m);if(rec){rec.status=s;}else{attendance.push({date:d,member:m,status:s});}saveData();document.getElementById("attendanceMsg").textContent="Saved ✅";setTimeout(()=>document.getElementById("attendanceMsg").textContent="",1200);}
  function renderTodayAttendance(){let today=todayStr();let box=document.getElementById("todayAttendance");box.innerHTML="";team.forEach(m=>{let rec=attendance.find(a=>a.date===today&&a.member===m);let st=rec?rec.status:"Absent";box.innerHTML+=`<span class="badge ${st.replace(" ","").toLowerCase()}">${m}: ${st}</span>`;});}
  function downloadAttendance(){let month=document.getElementById("reportMonth").value;if(!month){alert("Select month");return;}let rows=["Date,Member,Status"];attendance.filter(a=>a.date.startsWith(month)).forEach(a=>{rows.push(`${a.date},${a.member},${a.status}`);});let blob=new Blob([rows.join("\n")],{type:"text/csv"});let url=URL.createObjectURL(blob);let a=document.createElement("a");a.href=url;a.download=`attendance_${month}.csv`;a.click();URL.revokeObjectURL(url);}
  function loadDropdowns(){document.getElementById("clientName").innerHTML=clients.map(c=>`<option>${c}</option>`).join("");document.getElementById("assignedTo").innerHTML=team.map(m=>`<option>${m}</option>`).join("");}
  function statusText(s){return s==="pending"?"Pending":s==="inprogress"?"In Progress":"Completed";}
  function todayStr(){return new Date().toISOString().split("T")[0];}
  function openModal(id){document.getElementById(id).style.display="block";}
  function closeModal(id){document.getElementById(id).style.display="none";}
  
  // 🚀 Load data at start
  loadData();
</script>
</body>
</html>
